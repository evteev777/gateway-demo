# Gateway: Nginx и Spring Cloud

Проект с Nginx и Spring Cloud (Gateway, Eureka) - в качестве входной точки и балансировщика нагрузки

Создан в качестве примера к одной из лекций для стажировки в Лиге Цифровой Экономики 

## Работа с кодом проекта
Советую работать с этим проектом так же, как на лекции: 
- отвести ветку
- откатиться в ней на Initial commit
- добавлять в нее по одному коммиту из ветки develop (через Cherry-Pick)

И смотреть на результат: 
- что изменилось в коде
- какие сервисы, инстансы и эндпойнты появились
- на каких адресах и портах они расположены внутри и снаружи докер-сети
- что возвращает каждый эндпойнт, и почему

После масштабирования сервисов - на разных этапах отдельными коммитами добавлены коллекции для Postman. 
Можно их импортировать в Postman, и оттуда вызывать нужные методы: по одному, или все сразу (череp Run)

Также добавлен скрипт 'deploy.sh' - для сборки Maven-проекта и перезапуска Docker-контейнеров в Linux одной командой. 
Для его запуска надо сначала сделать файл исполняемым: 
```bash
sudo chmod +x ./deploy.sh
./deploy.sh
```

## Основные этапы:
- Создана основа многомодульного Maven-проекта, **добавлены три модуля**:
  - **Logger Service**: в методе POST /internal/v1/log-hostname принимает имя хоста в виде строки, и логирует его. Открыты /actuator/health, /actuator/info
  - **Reader Service**: при вызове метода GET /api/v2/info/instance-name возвращает имя хоста в виде строки, а также отправляет его с помощью Feign-клиента в Logger Service. Открыты /actuator/health, /actuator/info
  - **Writer Service**: при вызове метода GET /api/v2/info/instance-name возвращает имя хоста в виде строки, а также отправляет его с помощью Feign-клиента в Logger Service. Открыты /actuator/health, /actuator/info. Полный аналог Reader Service
- **Добавлен Docker Compose** для более простого деплоя и оркестрации
- **Добавлен Nginx** в качестве единой входной точки (gateway). При этом межсервисное взаимодействие внутри docker-сети тоже происходит через Nginx
- **Масштабирование** по три инстанса: Logger Service, Reader Service, Writer Service
- Частично закрыт доступ через Nginx:
  - Закрыт доступ к Logger Service снаружи докер-сети, при этом межсервисное взаимодействие все равно происходит через Nginx
  - Оставлено только публичное API /api/v1 у reader и writer. На все остальные запросы возвращается 403. Доступ только через Nginx
- **Добавлен Spring Cloud (Eureka и Gateway). Nginx временно отключен**. Добавлено сразу по три инстанса Eureka и Gateway. Все сервисы (актуаторы и эндпойнты контроллеров) доступны через Spring Cloud Gateway
- Частично закрыт доступ через Spring Cloud:
  - Сервисы Logger Service, Reader Service, Writer Service скрыты внутри docker-сети, и доступны только через Spring Cloud Gateway (актуаторы и ссылки из Web-UI Eureka недоступны)
- **Настроен доступ к Spring Cloud Gateway через Nginx**. Сам Spring Cloud Gateway скрыт внутри docker-сети (эндпойнты и актуаторы снаружи сети недоступны)
- **Черный ящик**: 
  - Nginx по корневому эндпойнту '/' отображает index.html 
  - Оставлен доступ через Nginx только к публичным методам /api/v1 в сервисах Reader Service и Writer Service
  - Другие методы /api в сервисах Reader Service и Writer Service возвращают 403 Forbidden
  - Сервис Logger Service и Spring Cloud (Gateway, Eureka) скрыты внутри докер-сети. Снаружи о них ничего не известно 
  - Внутри докер-сети Reader Service и Writer Service по прежнему обращаются к Logger Service через Spring Cloud (Gateway, Eureka)

**Если будут вопросы - пишите!**
